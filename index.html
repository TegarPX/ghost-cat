<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GhostChat</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
background:#020617;
color:#e5e7eb;
}

.card{
background:#020617;
border:1px solid #1e293b;
}

.chat-me{
background:#2563eb;
color:#fff;
border-radius:18px 18px 0 18px;
}

.chat-them{
background:#334155;
color:#fff;
border-radius:18px 18px 18px 0;
}

.chat-bubble{
max-width:85%;
word-wrap:break-word;
overflow-wrap:anywhere;
white-space:pre-wrap;
}

.system{
font-size:10px;
letter-spacing:.2em;
opacity:.6;
font-weight:900;
}

input{
background:#020617;
color:#f8fafc;
border:1px solid #1e293b;
}

input::placeholder{color:#64748b}
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 font-sans">

<!-- SETUP -->
<div id="setupCard" class="card p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md">
<h1 class="text-3xl font-black text-blue-500 text-center mb-6">
GHOST<span class="text-slate-400">CHAT</span>
</h1>

<input id="username" placeholder="Username"
class="w-full p-4 mb-3 rounded-2xl text-center font-bold">

<input id="roomLetter" maxlength="1" placeholder="A"
class="w-full p-4 mb-3 rounded-2xl text-center font-bold">

<input id="roomNumber" type="number" min="1000" max="9999" placeholder="1000"
class="w-full p-4 mb-5 rounded-2xl text-center font-bold">

<button onclick="initP2P()"
class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl">
Mulai Chatting
</button>
</div>

<!-- CHAT -->
<div id="chatInterface"
class="hidden w-full max-w-lg h-[90vh] card rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">

<!-- TOP BAR -->
<div class="bg-blue-600 text-white px-5 py-3 flex justify-between text-xs font-bold">
<span id="roomInfo">ROOM</span>
<span id="connInfo">0 Connected</span>
<span id="onlineInfo">0 Online</span>
</div>

<div id="messageBox" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4">
<div id="waitingText" class="self-center system">MENUNGGU PARTNER...</div>
</div>

<div class="p-4 border-t border-slate-800 flex gap-2">
<input id="messageInput" placeholder="Ketik pesan..."
class="flex-1 p-4 rounded-2xl outline-none">
<button onclick="sendMessage()"
class="bg-blue-600 text-white w-14 h-14 rounded-2xl">âž¤</button>
</div>
</div>

<script>
let peer, conn, myName="";

/* ===== GLOBAL ONLINE COUNTER ===== */
const NAMESPACE="ghostchat-erzy";
const KEY="global-online";

fetch(`https://api.countapi.xyz/create?namespace=${NAMESPACE}&key=${KEY}&value=0`)
.catch(()=>{});

function updateOnline(){
fetch(`https://api.countapi.xyz/hit/${NAMESPACE}/${KEY}`)
.then(r=>r.json())
.then(d=>onlineInfo.textContent=`${d.value} Online`);
}
updateOnline();
setInterval(()=>{
fetch(`https://api.countapi.xyz/get/${NAMESPACE}/${KEY}`)
.then(r=>r.json())
.then(d=>onlineInfo.textContent=`${d.value} Online`);
},5000);

/* ===== P2P ===== */
function initP2P(){
myName=username.value.trim();
const l=roomLetter.value.toUpperCase();
const n=roomNumber.value;
if(!myName||!l||!n) return alert("Lengkapi data!");

const roomId=`ghost-${l}-${n}`;
peer=new Peer(roomId);

peer.on("open",()=>{
showChat(l,n);
});

peer.on("connection",c=>{
conn=c;
setupConn();
});

peer.on("error",e=>{
if(e.type==="unavailable-id"){
peer=new Peer();
peer.on("open",()=>{
conn=peer.connect(roomId);
setupConn();
showChat(l,n);
});
}
});
}

function setupConn(){
conn.on("open",()=>{
waitingText.remove();
connInfo.textContent="1 Connected";
conn.send({sys:true,user:myName});
});

conn.on("data",d=>{
if(d.sys){
appendSystem(`${d.user} joined`);
connInfo.textContent="2 Connected";
}else{
appendChat(d.user,d.msg,false);
}
});
}

function showChat(l,n){
setupCard.classList.add("hidden");
chatInterface.classList.remove("hidden");
roomInfo.textContent=`ROOM ${l}-${n}`;
}

function sendMessage(){
if(!conn||!conn.open) return;
const msg=messageInput.value.trim();
if(!msg) return;
conn.send({user:myName,msg});
appendChat(myName,msg,true);
messageInput.value="";
}

function appendChat(user,msg,me){
const w=document.createElement("div");
w.className=me?"self-end":"self-start";
w.innerHTML=`
<div class="text-[10px] font-bold opacity-60 mb-1">${user}</div>
<div class="chat-bubble ${me?"chat-me":"chat-them"} p-4">${msg}</div>
`;
messageBox.appendChild(w);
messageBox.scrollTop=messageBox.scrollHeight;
}

function appendSystem(t){
const d=document.createElement("div");
d.className="self-center system";
d.textContent=t;
messageBox.appendChild(d);
}
</script>
</body>
</html>
