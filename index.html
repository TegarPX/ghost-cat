<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GhostChat</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
html,body{height:100%;background:#0f172a;color:#e5e7eb}
.chat-bubble-me{
  background:#2563eb;
  color:white;
  border-radius:16px 16px 4px 16px;
  word-break:break-word;
}
.chat-bubble-them{
  background:#334155;
  color:white;
  border-radius:16px 16px 16px 4px;
  word-break:break-word;
}
</style>
</head>
<body class="h-full flex flex-col">

<!-- ========== MAIN MENU ========== -->
<div id="menu" class="flex-1 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-slate-800 p-6 rounded-3xl space-y-4 shadow-xl">
    <h1 class="text-center text-3xl font-black">GhostChat</h1>

    <input id="username" placeholder="Username"
      class="w-full p-4 rounded-xl bg-slate-900 outline-none">

    <input id="roomLetter" maxlength="1" placeholder="Room A-Z"
      class="w-full p-4 rounded-xl bg-slate-900 uppercase outline-none">

    <input id="roomPort" type="number" placeholder="Port (1000-9999)"
      class="w-full p-4 rounded-xl bg-slate-900 outline-none">

    <button onclick="joinRoom()"
      class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded-xl font-bold">
      JOIN
    </button>
  </div>
</div>

<!-- ========== CHAT ========== -->
<div id="chat" class="hidden flex-1 flex flex-col">

<!-- TOP BAR -->
<div class="h-16 bg-slate-900 flex items-center justify-between px-4">
  <div>
    <div id="roomInfo" class="font-bold"></div>
    <div id="connInfo" class="text-xs opacity-70">connecting...</div>
  </div>
  <button onclick="location.reload()" class="text-sm">Keluar</button>
</div>

<!-- MESSAGES -->
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

<!-- INPUT -->
<div class="p-3 bg-slate-900 flex items-center gap-2">
  <input type="file" id="fileInput" hidden onchange="sendFile(this.files[0])">
  <button onclick="fileInput.click()">ðŸ“Ž</button>
  <button onclick="startRecord()">ðŸŽ¤</button>
  <input id="msg" placeholder="Message"
    class="flex-1 p-3 rounded-xl bg-slate-800 outline-none">
  <button onclick="sendText()">âž¤</button>
</div>

</div>

<script>
let peer,conn,username,mediaRecorder,audioChunks=[];

function joinRoom(){
  username=document.getElementById("username").value.trim();
  const l=roomLetter.value.toUpperCase();
  const p=roomPort.value;
  if(!username||!l||!p) return alert("Lengkapi data");

  const roomId=`ghost-${l}-${p}`;
  peer=new Peer(roomId);

  peer.on("open",()=>{
    openChat(l,p);
    addSystem("Menunggu partner...");
  });

  peer.on("connection",c=>{
    conn=c;
    setupConn();
  });

  peer.on("error",e=>{
    if(e.type==="unavailable-id"){
      peer=new Peer();
      peer.on("open",()=>{
        conn=peer.connect(roomId);
        setupConn();
        openChat(l,p);
      });
    }
  });
}

function setupConn(){
  conn.on("open",()=>{
    document.getElementById("connInfo").textContent="connected";
    addSystem("Terhubung");
  });

  conn.on("data",data=>{
    if(data.type==="text") addMsg(data.user,data.msg,false);
    if(data.type==="file") receiveFile(data);
    if(data.type==="audio") receiveAudio(data);
  });
}

function openChat(l,p){
  menu.classList.add("hidden");
  chat.classList.remove("hidden");
  roomInfo.textContent=`Room ${l}-${p}`;
}

function addSystem(t){
  const d=document.createElement("div");
  d.className="text-center text-xs opacity-60";
  d.textContent=t;
  messages.appendChild(d);
}

function addMsg(user,text,me){
  const w=document.createElement("div");
  w.className=`max-w-[80%] ${me?"self-end":"self-start"}`;
  const u=document.createElement("div");
  u.className="text-xs opacity-70 mb-1";
  u.textContent=user;
  const b=document.createElement("div");
  b.className=me?"chat-bubble-me p-3":"chat-bubble-them p-3";
  b.textContent=text;
  w.append(u,b);
  messages.appendChild(w);
  messages.scrollTop=messages.scrollHeight;
}

function sendText(){
  if(!conn||!conn.open) return;
  const t=msg.value.trim();
  if(!t) return;
  conn.send({type:"text",user:username,msg:t});
  addMsg("You",t,true);
  msg.value="";
}

function sendFile(file){
  const r=new FileReader();
  r.onload=()=>{
    conn.send({type:"file",user:username,name:file.name,data:r.result});
  };
  r.readAsDataURL(file);
}

function receiveFile(d){
  const a=document.createElement("a");
  a.href=d.data;
  a.download=d.name;
  a.textContent=`ðŸ“Ž ${d.name}`;
  messages.appendChild(a);
}

async function startRecord(){
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream);
  audioChunks=[];
  mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(audioChunks,{type:"audio/webm"});
    const r=new FileReader();
    r.onload=()=>{
      conn.send({type:"audio",user:username,data:r.result});
    };
    r.readAsDataURL(blob);
  };
  mediaRecorder.start();
  setTimeout(()=>mediaRecorder.stop(),4000);
}

function receiveAudio(d){
  const audio=document.createElement("audio");
  audio.src=d.data;
  audio.controls=true;
  messages.appendChild(audio);
}
</script>
</body>
</html>
