<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PesanKu.id</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
html,body{
  height:100%;
  background:#0f172a;
  color:#e5e7eb;
}
.chat-me{
  background:#2563eb;
  border-radius:16px 16px 4px 16px;
  word-break:break-word;
}
.chat-them{
  background:#334155;
  border-radius:16px 16px 16px 4px;
  word-break:break-word;
}
.file-btn{
  width:48px;
  height:48px;
  border-radius:9999px;
  border:2px solid #475569;
  display:flex;
  align-items:center;
  justify-content:center;
}
.file-link{
  color:#93c5fd;
  text-decoration:underline;
}
</style>
</head>

<body class="h-full flex flex-col">

<!-- SEARCHING POPUP -->
<div id="searchPopup" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-slate-900 p-6 rounded-2xl text-center w-64">
    <div class="text-lg font-bold">Searching server</div>
    <div id="counter" class="text-4xl font-black mt-2">5</div>
    <div class="text-xs opacity-60 mt-1">please wait...</div>
  </div>
</div>

<!-- MENU -->
<div id="menu" class="flex-1 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-slate-800 p-6 rounded-3xl space-y-4 shadow-xl">
    <h1 class="text-center text-3xl font-black">PesanKu.id</h1>

    <input id="username" placeholder="Username"
      class="w-full p-4 rounded-xl bg-slate-900 outline-none">

    <input id="roomLetter" maxlength="1" placeholder="Room A-Z"
      class="w-full p-4 rounded-xl bg-slate-900 uppercase outline-none">

    <input id="roomPort" type="number" placeholder="Port 1000-9999"
      class="w-full p-4 rounded-xl bg-slate-900 outline-none">

    <button id="joinBtn"
      class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded-xl font-bold">
      JOIN
    </button>
  </div>
</div>

<!-- CHAT -->
<div id="chat" class="hidden flex-1 flex flex-col">

<!-- TOP BAR -->
<div class="h-14 bg-slate-900 px-4 flex items-center justify-between">
  <div>
    <div id="roomInfo" class="font-bold"></div>
    <div id="connInfo" class="text-xs opacity-70">connecting...</div>
  </div>
  <button onclick="location.reload()" class="text-sm opacity-80">Keluar</button>
</div>

<!-- MESSAGES -->
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

<!-- INPUT BAR -->
<div class="p-3 bg-slate-900 flex items-center gap-2">
  <input type="file" id="fileInput" hidden>

  <button id="fileBtn" class="file-btn">ðŸ“Ž</button>

  <input id="msg" placeholder="Message"
    class="flex-1 p-3 rounded-xl bg-slate-800 outline-none">

  <button id="sendBtn"
    class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center">
    âž¤
  </button>
</div>
</div>

<script>
/* ========= GLOBAL ========= */
let peer, conn, username;
let timer;

/* ========= DOM ========= */
const joinBtn = document.getElementById("joinBtn");
const searchPopup = document.getElementById("searchPopup");
const counter = document.getElementById("counter");
const fileBtn = document.getElementById("fileBtn");
const fileInput = document.getElementById("fileInput");

/* ========= SEARCH POPUP ========= */
function showSearch(){
  searchPopup.classList.remove("hidden");
  let t = 5;
  counter.textContent = t;
  timer = setInterval(()=>{
    t--;
    counter.textContent = t;
    if(t <= 0) hideSearch();
  },1000);
}
function hideSearch(){
  clearInterval(timer);
  searchPopup.classList.add("hidden");
}

/* ========= JOIN ========= */
joinBtn.onclick = ()=>{
  username = document.getElementById("username").value.trim();
  const l = roomLetter.value.toUpperCase();
  const p = roomPort.value;
  if(!username || !l || !p) return alert("Lengkapi data");

  showSearch();
  const roomId = `pesanku-${l}-${p}`;

  peer = new Peer(roomId);

  peer.on("open", ()=>{
    openChat(l,p);
  });

  peer.on("connection", c=>{
    conn = c;
    setupConn();
  });

  peer.on("error", e=>{
    if(e.type === "unavailable-id"){
      peer = new Peer();
      peer.on("open", ()=>{
        conn = peer.connect(roomId);
        setupConn();
        openChat(l,p);
      });
    }
  });
};

/* ========= CONNECTION ========= */
function setupConn(){
  conn.on("open", ()=>{
    hideSearch();
    connInfo.textContent = "connected";
    systemMsg("Terhubung");
  });

  conn.on("data", d=>{
    if(d.type === "text") addMsg(d.user, d.msg, false);
    if(d.type === "file") recvFile(d);
  });
}

/* ========= UI ========= */
function openChat(l,p){
  menu.classList.add("hidden");
  chat.classList.remove("hidden");
  roomInfo.textContent = `Room ${l}-${p}`;
}
function systemMsg(t){
  const d = document.createElement("div");
  d.className = "text-center text-xs opacity-60";
  d.textContent = t;
  messages.appendChild(d);
}

/* ========= TEXT ========= */
sendBtn.onclick = ()=>{
  if(!conn || !conn.open) return;
  const t = msg.value.trim();
  if(!t) return;
  conn.send({type:"text", user:username, msg:t});
  addMsg("You", t, true);
  msg.value = "";
};

function addMsg(user,text,me){
  const w = document.createElement("div");
  w.className = `max-w-[80%] ${me?"self-end":"self-start"}`;
  w.innerHTML = `
    <div class="text-xs opacity-70 mb-1">${user}</div>
    <div class="${me?"chat-me":"chat-them"} p-3">${text}</div>
  `;
  messages.appendChild(w);
  messages.scrollTop = messages.scrollHeight;
}

/* ========= FILE ========= */
fileBtn.onclick = ()=> fileInput.click();

fileInput.onchange = ()=>{
  const f = fileInput.files[0];
  if(!f || !conn) return;
  const r = new FileReader();
  r.onload = ()=>{
    conn.send({type:"file", user:username, name:f.name, data:r.result});
  };
  r.readAsDataURL(f);
};

function recvFile(d){
  const a = document.createElement("a");
  a.href = d.data;
  a.download = d.name;
  a.textContent = `ðŸ“Ž ${d.name}`;
  a.className = "file-link block";
  messages.appendChild(a);
}
</script>

</body>
</html>
