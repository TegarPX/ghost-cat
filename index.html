<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GhostChat</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
margin:0;
background:#0b141a;
color:#e9edef;
font-family:system-ui;
}

/* HEADER */
.header{
background:#202c33;
height:56px;
}

/* CHAT AREA */
.chat-area{
background:#0b141a;
}

/* BUBBLES */
.bubble{
max-width:80%;
padding:8px 12px;
border-radius:8px;
word-wrap:break-word;
overflow-wrap:anywhere;
white-space:pre-wrap;
}

.me{
background:#005c4b;
align-self:flex-end;
border-bottom-right-radius:0;
}

.them{
background:#202c33;
align-self:flex-start;
border-bottom-left-radius:0;
}

.username{
font-size:11px;
opacity:.6;
margin-bottom:2px;
}

/* INPUT */
.input-bar{
background:#202c33;
height:56px;
}

input{
background:#2a3942;
color:#e9edef;
}

input::placeholder{color:#8696a0}
</style>
</head>

<body class="h-screen flex flex-col">

<!-- HEADER -->
<div class="header flex items-center justify-between px-4 text-sm font-semibold">
<div id="roomInfo">ROOM</div>
<div class="flex gap-3 text-xs opacity-80">
<span id="connInfo">0 connected</span>
<span id="onlineInfo">0 online</span>
</div>
</div>

<!-- SETUP -->
<div id="setupScreen" class="flex-1 flex items-center justify-center">
<div class="w-full max-w-sm px-6">
<input id="username" placeholder="Username"
class="w-full p-3 rounded mb-3 text-center">

<div class="flex gap-2 mb-3">
<input id="roomLetter" maxlength="1" placeholder="A"
class="w-1/3 p-3 rounded text-center">
<input id="roomNumber" type="number" placeholder="1000"
class="flex-1 p-3 rounded text-center">
</div>

<button onclick="initP2P()"
class="w-full bg-[#005c4b] py-3 rounded font-bold">
Mulai Chat
</button>
</div>
</div>

<!-- CHAT -->
<div id="chatScreen" class="hidden flex-1 flex flex-col">

<div id="messageBox"
class="chat-area flex-1 overflow-y-auto p-4 flex flex-col gap-3">
<div id="waitingText" class="text-xs opacity-60 self-center">
Menunggu partner...
</div>
</div>

<div class="input-bar flex items-center gap-2 px-3">
<input id="messageInput" placeholder="Ketik pesan"
class="flex-1 p-2 rounded outline-none">
<button onclick="sendMessage()"
class="text-[#00a884] font-bold px-3">âž¤</button>
</div>
</div>

<script>
let peer, conn, myName="";

/* ONLINE COUNTER */
const NS="ghostchat-whatsapp";
const KEY="online";
fetch(`https://api.countapi.xyz/create?namespace=${NS}&key=${KEY}&value=0`).catch(()=>{});
fetch(`https://api.countapi.xyz/hit/${NS}/${KEY}`)
.then(r=>r.json())
.then(d=>onlineInfo.textContent=d.value+" online");

setInterval(()=>{
fetch(`https://api.countapi.xyz/get/${NS}/${KEY}`)
.then(r=>r.json())
.then(d=>onlineInfo.textContent=d.value+" online");
},5000);

/* INIT */
function initP2P(){
myName=username.value.trim();
const l=roomLetter.value.toUpperCase();
const n=roomNumber.value;
if(!myName||!l||!n) return alert("Lengkapi data!");

const roomId=`ghost-${l}-${n}`;
peer=new Peer(roomId);

peer.on("open",()=>{
roomInfo.textContent=`ROOM ${l}-${n}`;
setupScreen.classList.add("hidden");
chatScreen.classList.remove("hidden");
});

peer.on("connection",c=>{
conn=c;
setupConn();
});

peer.on("error",e=>{
if(e.type==="unavailable-id"){
peer=new Peer();
peer.on("open",()=>{
conn=peer.connect(roomId);
setupConn();
roomInfo.textContent=`ROOM ${l}-${n}`;
setupScreen.classList.add("hidden");
chatScreen.classList.remove("hidden");
});
}
});
}

function setupConn(){
conn.on("open",()=>{
waitingText.remove();
connInfo.textContent="1 connected";
conn.send({sys:true,user:myName});
});

conn.on("data",d=>{
if(d.sys){
connInfo.textContent="2 connected";
appendSystem(`${d.user} joined`);
}else{
appendChat(d.user,d.msg,false);
}
});
}

function sendMessage(){
if(!conn||!conn.open) return;
const msg=messageInput.value.trim();
if(!msg) return;
conn.send({user:myName,msg});
appendChat(myName,msg,true);
messageInput.value="";
}

function appendChat(user,msg,me){
const wrap=document.createElement("div");
wrap.className="flex flex-col "+(me?"items-end":"items-start");
wrap.innerHTML=`
<div class="username">${user}</div>
<div class="bubble ${me?"me":"them"}">${msg}</div>
`;
messageBox.appendChild(wrap);
messageBox.scrollTop=messageBox.scrollHeight;
}

function appendSystem(t){
const d=document.createElement("div");
d.className="text-xs opacity-50 self-center";
d.textContent=t;
messageBox.appendChild(d);
}
</script>
</body>
</html>
