<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>GhostChat</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
:root{
  --bg:#0b141a;
  --header:#202c33;
  --input:#2a3942;
  --me:#005c4b;
  --them:#202c33;
  --text:#e9edef;
  --sub:#8696a0;
}
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}
.hidden{display:none}

/* ===== MAIN MENU ===== */
#menu{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.menu-box{
  width:90%;
  max-width:420px;
  background:#111b21;
  padding:20px;
  border-radius:12px;
}
.menu-box h2{text-align:center;margin-bottom:16px}
.menu-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.menu-grid input,select{
  grid-column:span 2;
  padding:12px;
  border-radius:8px;
  border:none;
  background:var(--input);
  color:var(--text);
}
.menu-grid .half{grid-column:span 1}
.menu-grid button{
  grid-column:span 2;
  padding:12px;
  border:none;
  border-radius:8px;
  background:#00a884;
  color:black;
  font-weight:bold;
  cursor:pointer;
}

/* ===== CHAT ===== */
#chat{
  display:flex;
  flex-direction:column;
  height:100vh;
}
#header{
  background:var(--header);
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#header small{color:var(--sub)}
#messages{
  flex:1;
  overflow-y:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.bubble{
  max-width:75%;
  padding:8px 10px;
  border-radius:10px;
  word-wrap:break-word;
}
.me{background:var(--me);align-self:flex-end}
.them{background:var(--them);align-self:flex-start}
.bubble .user{font-size:11px;color:#9de1d3}
.bubble img{max-width:100%;border-radius:6px}

/* ===== INPUT ===== */
#inputBar{
  background:var(--header);
  padding:8px;
  display:flex;
  gap:6px;
}
#inputBar input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:none;
  background:var(--input);
  color:var(--text);
}
#inputBar button{
  border:none;
  background:#00a884;
  border-radius:50%;
  width:40px;
  height:40px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ===== MENU ===== -->
<div id="menu">
  <div class="menu-box">
    <h2>GhostChat</h2>
    <div class="menu-grid">
      <input id="username" placeholder="Username">
      <select id="roomLetter" class="half">
        <option value="">Room</option>
        <script>
          for(let i=65;i<=90;i++)
            document.write(`<option>${String.fromCharCode(i)}</option>`)
        </script>
      </select>
      <input id="roomNumber" class="half" placeholder="Port">
      <button onclick="join()">JOIN</button>
    </div>
  </div>
</div>

<!-- ===== CHAT ===== -->
<div id="chat" class="hidden">
  <div id="header">
    <div>
      <b id="roomInfo"></b><br>
      <small id="status">Connecting...</small>
    </div>
    <small id="online">üë• 1 online</small>
  </div>

  <div id="messages"></div>

  <div id="inputBar">
    <button onclick="pickImage()">üñºÔ∏è</button>
    <button onclick="recordVoice()">üé§</button>
    <input id="msg" placeholder="Message">
    <button onclick="send()">‚û§</button>
  </div>
</div>

<input type="file" id="file" hidden>

<script>
let peer,conn,myName,online=1,mediaRecorder,chunks=[];

function join(){
  myName=username.value.trim();
  if(!myName||!roomLetter.value||!roomNumber.value) return alert("Lengkapi semua");
  menu.classList.add("hidden");
  chat.classList.remove("hidden");

  const room=`ghost-${roomLetter.value}-${roomNumber.value}`;
  roomInfo.textContent=room;

  peer=new Peer(room);
  peer.on("open",()=>status.textContent="Menunggu partner...");
  peer.on("connection",c=>connect(c));
  peer.on("error",e=>{
    if(e.type==="unavailable-id"){
      peer=new Peer();
      peer.on("open",()=>connect(peer.connect(room)));
    }
  });

  setInterval(()=>online.textContent=`üë• ${online} online`,1000);
}

function connect(c){
  conn=c;
  conn.on("open",()=>{
    status.textContent="Connected";
    online=2;
  });
  conn.on("data",data=>{
    online=2;
    if(data.type==="text") add(data.msg,data.user,"them");
    if(data.type==="img") addImg(data.data,data.user);
    if(data.type==="voice") addVoice(data.data,data.user);
  });
}

function add(msg,user,type){
  const b=document.createElement("div");
  b.className=`bubble ${type}`;
  b.innerHTML=`<div class="user">${user}</div>${msg}`;
  messages.appendChild(b);
  messages.scrollTop=messages.scrollHeight;
}

function send(){
  if(!msg.value||!conn?.open) return;
  add(msg.value,myName,"me");
  conn.send({type:"text",msg:msg.value,user:myName});
  msg.value="";
}

function pickImage(){
  file.accept="image/*";
  file.onchange=()=>{
    const r=new FileReader();
    r.onload=()=>{
      addImg(r.result,myName,"me");
      conn.send({type:"img",data:r.result,user:myName});
    };
    r.readAsDataURL(file.files[0]);
  };
  file.click();
}

function addImg(src,user,type="them"){
  const b=document.createElement("div");
  b.className=`bubble ${type}`;
  b.innerHTML=`<div class="user">${user}</div><img src="${src}">`;
  messages.appendChild(b);
  messages.scrollTop=messages.scrollHeight;
}

function recordVoice(){
  navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
    mediaRecorder=new MediaRecorder(s);
    chunks=[];
    mediaRecorder.ondataavailable=e=>chunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const blob=new Blob(chunks,{type:"audio/ogg"});
      const r=new FileReader();
      r.onload=()=>{
        addVoice(r.result,myName,"me");
        conn.send({type:"voice",data:r.result,user:myName});
      };
      r.readAsDataURL(blob);
    };
    mediaRecorder.start();
    setTimeout(()=>mediaRecorder.stop(),3000);
  });
}

function addVoice(src,user,type="them"){
  const b=document.createElement("div");
  b.className=`bubble ${type}`;
  b.innerHTML=`<div class="user">${user}</div><audio controls src="${src}"></audio>`;
  messages.appendChild(b);
  messages.scrollTop=messages.scrollHeight;
}
</script>

</body>
</html>
