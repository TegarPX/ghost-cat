<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GhostChat Ultra</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
.smooth{transition:.3s}
.mode-bright{background:#f1f5f9;color:#0f172a}
.card-bright{background:#fff;border:1px solid #e2e8f0}
.mode-dark{background:#0f172a}
.card-dark{background:#1e293b;border:1px solid #334155}

.chat-me{background:#2563eb;color:#fff;border-radius:18px 18px 0 18px}
.chat-them{background:#475569;color:#fff;border-radius:18px 18px 18px 0}

.system{font-size:10px;font-weight:900;opacity:.6;letter-spacing:.2em}

.mode-dark input{background:#020617;color:#f8fafc}
.mode-dark input::placeholder{color:#64748b}
</style>
</head>

<body id="mainBody"
class="mode-bright min-h-screen flex items-center justify-center p-4 font-sans smooth">

<!-- SETUP -->
<div id="setupCard" class="card-bright p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md">
<h1 class="text-3xl font-black text-blue-600 text-center mb-6">
GHOST<span class="text-slate-400">CHAT</span>
</h1>

<input id="username" placeholder="Username"
class="w-full p-4 mb-3 rounded-2xl text-center font-bold border">

<input id="roomLetter" maxlength="1" placeholder="A"
class="w-full p-4 mb-3 rounded-2xl text-center font-bold border">

<input id="roomNumber" type="number" min="1000" max="9999" placeholder="1000"
class="w-full p-4 mb-5 rounded-2xl text-center font-bold border">

<button onclick="initP2P()"
class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl">
Mulai Chatting
</button>
</div>

<!-- CHAT -->
<div id="chatInterface"
class="hidden w-full max-w-lg h-[90vh] card-bright rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">

<!-- TOP BAR -->
<div class="bg-blue-600 text-white px-5 py-3 flex justify-between items-center text-xs font-bold">
<span id="roomInfo">ROOM</span>
<span id="connInfo">0 Connected</span>
<span id="onlineInfo">0 Online</span>
</div>

<div id="messageBox" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4">
<div id="waitingText" class="self-center system">MENUNGGU PARTNER...</div>
</div>

<div class="p-4 border-t flex gap-2">
<input id="messageInput" placeholder="Ketik pesan..."
class="flex-1 p-4 rounded-2xl outline-none">
<button onclick="sendMessage()"
class="bg-blue-600 text-white w-14 h-14 rounded-2xl">âž¤</button>
</div>
</div>

<script>
let peer, conn, myName="", connected=false;

/* GLOBAL ONLINE COUNTER */
const COUNTER_KEY="ghostchat-global";
fetch(`https://api.countapi.xyz/hit/${COUNTER_KEY}/visits`)
.then(r=>r.json())
.then(d=>onlineInfo.textContent=`${d.value} Online`);

/* INIT */
function initP2P(){
myName=username.value.trim();
const l=roomLetter.value.toUpperCase();
const n=roomNumber.value;
if(!myName||!l||!n) return alert("Lengkapi data!");

const roomId=`ghost-${l}-${n}`;
peer=new Peer(roomId);

peer.on("open",()=>{
showChat(l,n);
});

peer.on("connection",c=>{
conn=c;
setupConn();
});

peer.on("error",e=>{
if(e.type==="unavailable-id"){
peer=new Peer();
peer.on("open",()=>{
conn=peer.connect(roomId);
setupConn();
showChat(l,n);
});
}
});
}

/* CONNECTION */
function setupConn(){
conn.on("open",()=>{
connected=true;
waitingText.remove();
connInfo.textContent="1 Connected";
conn.send({user:myName,sys:true});
});

conn.on("data",d=>{
if(d.sys){
appendSystem(`${d.user} joined`);
connInfo.textContent="2 Connected";
}else{
appendChat(d.user,d.msg,false);
}
});
}

/* UI */
function showChat(l,n){
setupCard.classList.add("hidden");
chatInterface.classList.remove("hidden");
roomInfo.textContent=`ROOM ${l}-${n}`;
}

function sendMessage(){
if(!conn||!conn.open) return;
const msg=messageInput.value.trim();
if(!msg) return;
conn.send({user:myName,msg});
appendChat(myName,msg,true);
messageInput.value="";
}

function appendChat(user,msg,me){
const wrap=document.createElement("div");
wrap.className=me?"self-end":"self-start";
wrap.innerHTML=`
<div class="text-[10px] font-bold opacity-60 mb-1">${user}</div>
<div class="${me?"chat-me":"chat-them"} p-4 max-w-[85%]">${msg}</div>
`;
messageBox.appendChild(wrap);
messageBox.scrollTop=messageBox.scrollHeight;
}

function appendSystem(t){
const d=document.createElement("div");
d.className="self-center system";
d.textContent=t;
messageBox.appendChild(d);
}
</script>
</body>
</html>
